<!-- coded with AI. NO WARRANTY -->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra HDR viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .image-container>div {
            flex: 1;
            min-width: 300px;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <h1>Ultra HDR Data Viewer for JPEG Files</h1>
    <input type="file" id="fileInput" accept=".jpg,.jpeg">
    <div class="image-container">
		<div>
            <h2>HDR</h2>
            <img id="hdrImage" alt="HDR Image">
        </div>	
		<div>
            <h2>SDR</h2>
            <img id="firstImage" alt="First Image">
        </div>
		 <div>
			 <h2>GainMap</h2>
            <img id="secondImage" alt="Second Image">
        </div>


    </div>
      <div>
	    <div>
			<h2 id="imageResolution" />
			<h3><text id="firstImageXmp" /></h3>
			<h3><text id="secondImageXmp" /></h3>
	       <h4>Comments: Google Chrome, Microsoft Edge support HDR. FireFox not support. Modify by Zorro@2024</h4>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.23.3/dist/exif-reader.min.js"></script>
    <script>
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file =	 e.target.files[0];
			size = (file.size / 1024).toFixed(2) + 'kB';
					
			console.log(file, "size", size);					
			
			getResolution(file)
            processImage(file, e);
        });
		
		async  function getResolution(file) {
			const fileBase64 = await  getBase64(file);
			//console.log("fileBase64", fileBase64);					
			const res = await  getImgPx(fileBase64);
			console.log("resolution", res.width,"x", res.height);	
			
			var y=document.getElementById("imageResolution");
			y.innerHTML="Resolution:"+res.width.toString()+"x"+res.height.toString();
		}
		function getImgPx(img) {
			const image = new Image();
			image.src = img;

			return new Promise((resolve) => {
				image.onload = () => {
					const width = image.width;
					const height = image.height;
					resolve({ width, height });
				};
			});
		}

		function getBase64(file){
			const reader = new FileReader();
			reader.readAsDataURL(file);
			return new Promise((resolve) => {
				reader.onload = () => {
					resolve(reader.result);
				};
			});
		}


		function processOneImage(e1, imageOffset, imageLength, imageTag) {
			const file = e1.target.files[0];
            const reader = new FileReader();
			console.log(file, imageTag, ' imageOffset:', imageOffset, 'imageLength', imageLength);
			
            reader.onload = function (e, offset=imageOffset, length=imageLength) {
				const buffer = e.target.result;
				// if(offset == -1) {
				//     offset = buffer.byteLength - length;
				// }
				const imageBuffer = e.target.result.slice(offset, offset+length);
				const imageBlob = new Blob([imageBuffer], { type: 'image/jpeg' });

				displayImage(imageBlob, imageTag); //imageTag='secondImage'

				// 2nd Exif
				ExifReader.load(imageBuffer, { async: true, expanded: true }).then((tags) => {
					// APP1 XMP
					const xmpData = tags['xmp'];
								/* Sample
									<x:xmpmeta xmlns:x=\"adobe:ns:meta/\" x:xmptk=\"Adobe XMP Core 5.5.0\">
										<rdf:RDF xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">
											<rdf:Description rdf:about=\"\"
												xmlns:hdrgm=\"http://ns.adobe.com/hdr-gain-map/1.0/\" 
												hdrgm:Version=\"1.0\" 
												hdrgm:GainMapMin=\"0.000000\" 
												hdrgm:GainMapMax=\"2.500000\" 
												hdrgm:Gamma=\"1.000000\" 
												hdrgm:OffsetSDR=\"0.000000\" 
												hdrgm:OffsetHDR=\"0.000000\" 
												hdrgm:HDRCapacityMin=\"0.000000\" 
												hdrgm:HDRCapacityMax=\"2.300000\" 
												hdrgm:BaseRenditionIsHDR=\"False\"/>
										</rdf:RDF>
									</x:xmpmeta>
								*/
					if (xmpData) {
						console.log(' XMP:', xmpData);
						
						var y=document.getElementById("secondImageXmp");
						y.innerHTML="secondImageXmp:"+JSON.stringify(xmpData);
					}
					
					console.log(' tags:', tags);

					// console.log(imageTag,' size:', tags['Image Width'], 'x', tags['Image Height']);
				}).catch((error) => {
					console.error('Exif error ():', error);
				});

            }
            reader.readAsArrayBuffer(file);		
		}

        function processImage(file, e) {
            ExifReader.load(file, { async: true, expanded: true }).then((tags) => {

                // process first image
                //displayImage(file, 'hdrImage');
                const xmpData = tags['xmp'];
                var possiblySecondMapLength = 0;
                /* Sample:
                    <?xpacket begin="ï»¿" id="W5M0MpCehiHzreSzNTczkc9d"?>
                    <x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 5.5.0">
                        <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
                            <rdf:Description rdf:about=""
                                xmlns:hdrgm="http://ns.adobe.com/hdr-gain-map/1.0/"
                                xmlns:Container="http://ns.google.com/photos/1.0/container/"
                                xmlns:Item="http://ns.google.com/photos/1.0/container/item/" hdrgm:Version="1.0">
                                <Container:Directory>
                                    <rdf:Bag>
                                        <rdf:li rdf:parseType="Resource">
                                            <Container:Item Item:Mime="image/jpeg" Item:Semantic="Primary" Item:Length="0" Item:Padding="0"/>
                                        </rdf:li>
                                        <rdf:li rdf:parseType="Resource">
                                            <Container:Item Item:Mime="image/jpeg" Item:Semantic="Gainmap" Item:Length="64540" Item:Padding="0"/>
                                        </rdf:li>
                                    </rdf:Bag>
                                </Container:Directory>
                            </rdf:Description>
                        </rdf:RDF>
                    </x:xmpmeta><?xpacket end="w"?>
                */
                if (xmpData) {
                    console.log('1st XMP:', xmpData);
                    //possiblySecondMapLength = Number(xmpData.Directory.value[1].Item.value.Length.value);
                    // console.log('1st size:', tags['Image Width'], 'x', tags['Image Height']);
					var y=document.getElementById("firstImageXmp");
					let toString = obj => Object.entries(obj).map(([k, v]) => `${k}: ${v}`).join(', ');

					y.innerHTML="firstImageXmp:"+JSON.stringify(xmpData);
                }


                var has_second_image = false;
                var secondImageOffset = 0;
                var secondImageLength = 0;
                const mpfData = tags['mpf'];
                if (mpfData) {
					console.log('mpfData:', mpfData); 
                    console.log('mpfData.Images[0]:', mpfData.Images[0]); 
                    console.log('mpfData.Images[1]:', mpfData.Images[1]); 
                    secondImageOffset = mpfData.Images[1].ImageOffset.value;
                    secondImageLength = mpfData.Images[1].ImageSize.value;
                    if (secondImageLength !=0 & secondImageOffset!=0)
                        has_second_image = true
						console.log('secondImageOffset:', secondImageOffset, 'secondImageLength', secondImageLength);
                }
				// process second image
                if (has_second_image) {
					processOneImage(e, 0, secondImageOffset+secondImageLength, 'hdrImage');
                	processOneImage(e, 0, secondImageOffset, 'firstImage');
                } else {
					displayImage(file, 'hdrImage');
				}				
                // process second image
                if (has_second_image) {
					processOneImage(e, secondImageOffset, secondImageLength, 'secondImage');
                }


            }).catch((error) => {
                console.error('Exif error (1st):', error);
            });
        };


        function displayImage(blob, elementId) {
            const url = URL.createObjectURL(blob);
            document.getElementById(elementId).src = url;
        }
    </script>
</body>

</html>